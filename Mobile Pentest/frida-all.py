
from __future__ import print_function
import threading
import base64
import frida
from frida_tools.application import Reactor
from argparse import ArgumentParser

class Application(object):

    def __init__(self, target):
        
        self.target = target
        
        self._stop_requested = threading.Event()
        self._reactor = Reactor(run_until_return=lambda reactor: self._stop_requested.wait())

        self._device = frida.get_device_manager().enumerate_devices()[-1]
        self._device.enable_spawn_gating()
        self._sessions = set()
        self._device.on("spawn-added", lambda child: self._reactor.schedule(lambda: self._on_child_added(child)))
        self._device.on("spawn-removed", lambda child: self._reactor.schedule(lambda: self._on_child_removed(child)))
        self._device.on("child-added", lambda child: self._reactor.schedule(lambda: self._on_child_added(child)))
        self._device.on("child-removed", lambda child: self._reactor.schedule(lambda: self._on_child_removed(child)))
        self._device.on("output", lambda pid, fd, data: self._reactor.schedule(lambda: self._on_output(pid, fd, data)))

    def run(self):
        
        self._reactor.schedule(lambda: self._start())
        self._reactor.run()

    def _start(self):
        
        pid = self._device.spawn(self.target)
        self._instrument(pid)

    def _stop_if_idle(self):
        
        if len(self._sessions) == 0:
            self._stop_requested.set()

    def _instrument(self, pid):
        
        try:
            
            print("✔ attach(pid={})".format(pid))
            session = self._device.attach(pid)
            session.on("detached", lambda reason: self._reactor.schedule(lambda: self._on_detached(pid, session, reason)))
            print("✔ enable_child_gating()")
            session.enable_child_gating()
            print("✔ create_script()")
            script_bypass = session.create_script(base64.b64decode("Y29uc3QgY29tbW9uUGF0aHMgPSBbCiAgICAiL2RhdGEvbG9jYWwvYmluL3N1IiwKICAgICIvZGF0YS9sb2NhbC9zdSIsCiAgICAiL2RhdGEvbG9jYWwveGJpbi9zdSIsCiAgICAiL2Rldi9jb20ua291c2hpa2R1dHRhLnN1cGVydXNlci5kYWVtb24vIiwKICAgICIvc2Jpbi9zdSIsCiAgICAiL3N5c3RlbS9hcHAvU3VwZXJ1c2VyLmFwayIsCiAgICAiL3N5c3RlbS9iaW4vZmFpbHNhZmUvc3UiLAogICAgIi9zeXN0ZW0vYmluL3N1IiwKICAgICIvc3UvYmluL3N1IiwKICAgICIvc3lzdGVtL2V0Yy9pbml0LmQvOTlTdXBlclNVRGFlbW9uIiwKICAgICIvc3lzdGVtL3NkL3hiaW4vc3UiLAogICAgIi9zeXN0ZW0veGJpbi9idXN5Ym94IiwKICAgICIvc3lzdGVtL3hiaW4vZGFlbW9uc3UiLAogICAgIi9zeXN0ZW0veGJpbi9zdSIsCiAgICAiL3N5c3RlbS9zYmluL3N1IiwKICAgICIvdmVuZG9yL2Jpbi9zdSIsCiAgICAiL2NhY2hlL3N1IiwKICAgICIvZGF0YS9zdSIsCiAgICAiL2Rldi9zdSIsCiAgICAiL3N5c3RlbS9iaW4vLmV4dC9zdSIsCiAgICAiL3N5c3RlbS91c3Ivd2UtbmVlZC1yb290L3N1IiwKICAgICIvc3lzdGVtL2FwcC9LaW5ndXNlci5hcGsiLAogICAgIi9kYXRhL2FkYi9tYWdpc2siLAogICAgIi9zYmluLy5tYWdpc2siLAogICAgIi9jYWNoZS8uZGlzYWJsZV9tYWdpc2siLAogICAgIi9kZXYvLm1hZ2lzay51bmJsb2NrIiwKICAgICIvY2FjaGUvbWFnaXNrLmxvZyIsCiAgICAiL2RhdGEvYWRiL21hZ2lzay5pbWciLAogICAgIi9kYXRhL2FkYi9tYWdpc2suZGIiLAogICAgIi9kYXRhL2FkYi9tYWdpc2tfc2ltcGxlIiwKICAgICIvaW5pdC5tYWdpc2sucmMiLAogICAgIi9zeXN0ZW0veGJpbi9rdS5zdWQiLAogICAgIi9kYXRhL2FkYi9rc3UiLAogICAgIi9kYXRhL2FkYi9rc3VkIiwKXTsKCmNvbnN0IFJPT1RtYW5hZ2VtZW50QXBwID0gWwogICAgImNvbS5ub3NodWZvdS5hbmRyb2lkLnN1IiwKICAgICJjb20ubm9zaHVmb3UuYW5kcm9pZC5zdS5lbGl0ZSIsCiAgICAiZXUuY2hhaW5maXJlLnN1cGVyc3UiLAogICAgImNvbS5rb3VzaGlrZHV0dGEuc3VwZXJ1c2VyIiwKICAgICJjb20udGhpcmRwYXJ0eS5zdXBlcnVzZXIiLAogICAgImNvbS55ZWxsb3dlcy5zdSIsCiAgICAiY29tLmtvdXNoaWtkdXR0YS5yb21tYW5hZ2VyIiwKICAgICJjb20ua291c2hpa2R1dHRhLnJvbW1hbmFnZXIubGljZW5zZSIsCiAgICAiY29tLmRpbW9udmlkZW8ubHVja3lwYXRjaGVyIiwKICAgICJjb20uY2hlbHB1cy5sYWNreXBhdGNoIiwKICAgICJjb20ucmFtZHJvaWQuYXBwcXVhcmFudGluZSIsCiAgICAiY29tLnJhbWRyb2lkLmFwcHF1YXJhbnRpbmVwcm8iLAogICAgImNvbS50b3Bqb2hud3UubWFnaXNrIiwKICAgICJtZS53ZWlzaHUua2VybmVsc3UiLApdOwoKLyoqCiAqIEJ5cGFzcyBFbXVsYXRvciBEZXRlY3Rpb24KICogQHBhcmFtIHthbnl9IGZ1bmN0aW9uKAogKiBAcmV0dXJucyB7YW55fQogKi8KSmF2YS5wZXJmb3JtKGZ1bmN0aW9uICgpIHsKCiAgICBjb25zb2xlLmxvZygiXG5bKl0gSW5qZWN0aW9uIENvZGUiKTsKCiAgICAvKiBTcGxpdCBTU0wgUGlubmluZyAqLwoKICAgIHZhciBhcnJheV9saXN0ID0gSmF2YS51c2UoImphdmEudXRpbC5BcnJheUxpc3QiKTsKICAgIHZhciBBcGlDbGllbnQgPSBKYXZhLnVzZSgnY29tLmFuZHJvaWQub3JnLmNvbnNjcnlwdC5UcnVzdE1hbmFnZXJJbXBsJyk7CgogICAgQXBpQ2xpZW50LmNoZWNrVHJ1c3RlZFJlY3Vyc2l2ZS5pbXBsZW1lbnRhdGlvbiA9IGZ1bmN0aW9uIChhMSwgYTIsIGEzLCBhNCwgYTUsIGE2KSB7CiAgICAgICAgY29uc29sZS5sb2coJ1sqXSBCeXBhc3NpbmcgU1NMIFBpbm5pbmcnKTsKICAgICAgICB2YXIgayA9IGFycmF5X2xpc3QuJG5ldygpOwogICAgICAgIHJldHVybiBrOwogICAgfQoKICAgIC8qIEJ5cGFzcyBPS0hUVFB2MyAqLwoKICAgIGNvbnN0IFVudmVyaWZpZWRDZXJ0RXJyb3IgPSBKYXZhLnVzZSgnamF2YXgubmV0LnNzbC5TU0xQZWVyVW52ZXJpZmllZEV4Y2VwdGlvbicpOwoKICAgIFVudmVyaWZpZWRDZXJ0RXJyb3IuJGluaXQuaW1wbGVtZW50YXRpb24gPSBmdW5jdGlvbiAoc3RyKSB7CgogICAgICAgIGNvbnN0IHN0YWNrVHJhY2UgPSBKYXZhLnVzZSgnamF2YS5sYW5nLlRocmVhZCcpLmN1cnJlbnRUaHJlYWQoKS5nZXRTdGFja1RyYWNlKCk7CiAgICAgICAgY29uc3QgZXhjZXB0aW9uU3RhY2tJbmRleCA9IHN0YWNrVHJhY2UuZmluZEluZGV4KHN0YWNrID0+CiAgICAgICAgICAgIHN0YWNrLmdldENsYXNzTmFtZSgpID09PSAiamF2YXgubmV0LnNzbC5TU0xQZWVyVW52ZXJpZmllZEV4Y2VwdGlvbiIKICAgICAgICApOwogICAgICAgIGNvbnN0IGNhbGxpbmdGdW5jdGlvblN0YWNrID0gc3RhY2tUcmFjZVtleGNlcHRpb25TdGFja0luZGV4ICsgMV07CgogICAgICAgIGNvbnN0IGNsYXNzTmFtZSA9IGNhbGxpbmdGdW5jdGlvblN0YWNrLmdldENsYXNzTmFtZSgpOwogICAgICAgIGNvbnN0IG1ldGhvZE5hbWUgPSBjYWxsaW5nRnVuY3Rpb25TdGFjay5nZXRNZXRob2ROYW1lKCk7CiAgICAgICAgY29uc29sZS5sb2coYFsqXSBEZWJ1Z2dpbmcgU3RhY2sgVHJhY2UgZm9yIFNTTFBlZXJVbnZlcmlmaWVkRXhjZXB0aW9uYCk7CiAgICAgICAgY29uc29sZS5sb2coYFsqXSBUaHJvd24gYnkgJHtjbGFzc05hbWV9LT4ke21ldGhvZE5hbWV9YCk7CiAgICB9OwoKICAgIHRyeSB7CgogICAgICAgIGNvbnN0IG9raHR0cDNfQWN0aXZpdHlfNCA9IEphdmEudXNlKCdva2h0dHAzLkNlcnRpZmljYXRlUGlubmVyJyk7CiAgICAgICAgb2todHRwM19BY3Rpdml0eV80LmNoZWNrJG9raHR0cC5vdmVybG9hZCgnamF2YS5sYW5nLlN0cmluZycsICdrb3RsaW4uanZtLmZ1bmN0aW9ucy5GdW5jdGlvbjAnKS5pbXBsZW1lbnRhdGlvbiA9IGZ1bmN0aW9uIChhLCBiKSB7CgogICAgICAgICAgICBjb25zb2xlLmxvZygnWypdIEJ5cGFzc2luZyBPa0hUVFB2MyAoJG9raHR0cCk6ICcgKyBhKTsKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICB9OwoKICAgICAgICBjb25zb2xlLmxvZygnWytdIE9rSFRUUHYzICgkb2todHRwKScpOwoKICAgIH0gY2F0Y2ggKGVycikgewoKICAgICAgICBjb25zb2xlLmxvZygnWy1dIE9rSFRUUHYzICgkb2todHRwKScpOwoKICAgIH0KCiAgICAvKiBGYWtlIExvY2F0aW9uICovCgogICAgY29uc3QgbGF0X2xvYyA9IDI3Ljk4NjQ4ODI7CiAgICBjb25zdCBsbmdfbG9jID0gMzMuNzI3OTAwMTsKCiAgICB2YXIgTG9jYXRpb24gPSBKYXZhLnVzZSgiYW5kcm9pZC5sb2NhdGlvbi5Mb2NhdGlvbiIpOwogICAgTG9jYXRpb24uZ2V0TGF0aXR1ZGUuaW1wbGVtZW50YXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgc2VuZCgiWypdIE92ZXJ3cml0aW5nIExhdCB0byAiICsgbGF0X2xvYyk7CiAgICAgICAgcmV0dXJuIGxhdF9sb2M7CiAgICB9CiAgICBMb2NhdGlvbi5nZXRMb25naXR1ZGUuaW1wbGVtZW50YXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgc2VuZCgiWypdIE92ZXJ3cml0aW5nIExuZyB0byAiICsgbG5nX2xvYyk7CiAgICAgICAgcmV0dXJuIGxuZ19sb2M7CiAgICB9CgogICAgSmF2YS51c2UoImFuZHJvaWQub3MuQnVpbGQiKS5QUk9EVUNULnZhbHVlID0gImdyYWNlcmx0ZXh4IjsKICAgIEphdmEudXNlKCJhbmRyb2lkLm9zLkJ1aWxkIikuTUFOVUZBQ1RVUkVSLnZhbHVlID0gInNhbXN1bmciOwogICAgSmF2YS51c2UoImFuZHJvaWQub3MuQnVpbGQiKS5CUkFORC52YWx1ZSA9ICJzYW1zdW5nIjsKICAgIEphdmEudXNlKCJhbmRyb2lkLm9zLkJ1aWxkIikuREVWSUNFLnZhbHVlID0gImdyYWNlcmx0ZSI7CiAgICBKYXZhLnVzZSgiYW5kcm9pZC5vcy5CdWlsZCIpLk1PREVMLnZhbHVlID0gIlNNLU45MzVGIjsKICAgIEphdmEudXNlKCJhbmRyb2lkLm9zLkJ1aWxkIikuSEFSRFdBUkUudmFsdWUgPSAic2Ftc3VuZ2V4eW5vczg4OTAiOwogICAgSmF2YS51c2UoImFuZHJvaWQub3MuQnVpbGQiKS5GSU5HRVJQUklOVC52YWx1ZSA9CiAgICAgICAgInNhbXN1bmcvZ3JhY2VybHRleHgvZ3JhY2VybHRlOjguMC4wL1IxNk5XL045MzVGWFhTNEJSSzI6dXNlci9yZWxlYXNlLWtleXMiOwoKCiAgICB0cnkgewogICAgICAgIEphdmEudXNlKCJqYXZhLmlvLkZpbGUiKS5leGlzdHMuaW1wbGVtZW50YXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBuYW1lID0gSmF2YS51c2UoImphdmEuaW8uRmlsZSIpLmdldE5hbWUuY2FsbCh0aGlzKTsKICAgICAgICAgICAgdmFyIGNhdGNoZWQgPSBbInFlbXVkIiwgInFlbXVfcGlwZSIsICJkcml2ZXJzIiwgImNwdWluZm8iXS5pbmRleE9mKG5hbWUpID4gLTE7CiAgICAgICAgICAgIGlmIChjYXRjaGVkKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiWypdIHRoZSBwaXBlICIgKyBuYW1lICsgIiBleGlzdGVuY2UgaXMgaG9va2VkIik7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5leGlzdHMuY2FsbCh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBjb25zb2xlLmxvZygiWy1dIGphdmEuaW8uRmlsZS5leGlzdHMgbmV2ZXIgY2FsbGVkIFstXSIpOwogICAgfQoKICAgIC8vIHJlbmFtZSB0aGUgcGFja2FnZSBuYW1lcwogICAgdHJ5IHsKICAgICAgICBKYXZhLnVzZSgiYW5kcm9pZC5hcHAuQXBwbGljYXRpb25QYWNrYWdlTWFuYWdlciIpLmdldFBhY2thZ2VJbmZvLm92ZXJsb2FkKAogICAgICAgICAgICAiamF2YS5sYW5nLlN0cmluZyIsCiAgICAgICAgICAgICJpbnQiCiAgICAgICAgKS5pbXBsZW1lbnRhdGlvbiA9IGZ1bmN0aW9uIChuYW1lLCBmbGFnKSB7CiAgICAgICAgICAgIHZhciBjYXRjaGVkID0gWyJjb20uZXhhbXBsZS5hbmRyb2lkLmFwaXMiLCAiY29tLmFuZHJvaWQuZGV2ZWxvcG1lbnQiXS5pbmRleE9mKG5hbWUpID4KICAgICAgICAgICAgICAgIC0xOwogICAgICAgICAgICBpZiAoY2F0Y2hlZCkgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIlsqXSB0aGUgcGFja2FnZSAiICsgbmFtZSArICIgaXMgcmVuYW1lZCB3aXRoIGZha2UgbmFtZSIpOwogICAgICAgICAgICAgICAgbmFtZSA9ICJmYWtlLnBhY2thZ2UubmFtZSI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UGFja2FnZUluZm8uY2FsbCh0aGlzLCBuYW1lLCBmbGFnKTsKICAgICAgICB9OwogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgY29uc29sZS5sb2coCiAgICAgICAgICAgICJbLV0gQXBwbGljYXRpb25QYWNrYWdlTWFuYWdlci5nZXRQYWNrYWdlSW5mbyBuZXZlciBjYWxsZWQgWy1dIgogICAgICAgICk7CiAgICB9CgogICAgLy8gaG9vayB0aGUgYGFuZHJvaWRfZ2V0Q3B1RmFtaWx5YCBtZXRob2QKICAgIC8vIGh0dHBzOi8vYW5kcm9pZC5nb29nbGVzb3VyY2UuY29tL3BsYXRmb3JtL25kay8rL21hc3Rlci9zb3VyY2VzL2FuZHJvaWQvY3B1ZmVhdHVyZXMvY3B1LWZlYXR1cmVzLmMjMTA2NwogICAgLy8gTm90ZTogSWYgeW91IHBhc3MgIm51bGwiIGFzIHRoZSBmaXJzdCBwYXJhbWV0ZXIgZm9yICJNb2R1bGUuZmluZEV4cG9ydEJ5TmFtZSIgaXQgd2lsbCBzZWFyY2ggaW4gYWxsIG1vZHVsZXMKICAgIHRyeSB7CiAgICAgICAgSW50ZXJjZXB0b3IuYXR0YWNoKE1vZHVsZS5maW5kRXhwb3J0QnlOYW1lKG51bGwsICJhbmRyb2lkX2dldENwdUZhbWlseSIpLCB7CiAgICAgICAgICAgIG9uTGVhdmU6IGZ1bmN0aW9uIChyZXR2YWwpIHsKICAgICAgICAgICAgICAgIC8vIGNvbnN0IGludCBBTkRST0lEX0NQVV9GQU1JTFlfWDg2ID0gMjsKICAgICAgICAgICAgICAgIC8vIGNvbnN0IGludCBBTkRST0lEX0NQVV9GQU1JTFlfWDg2XzY0ID0gNTsKICAgICAgICAgICAgICAgIGlmIChbMiwgNV0uaW5kZXhPZihyZXR2YWwpID4gLTEpIHsKICAgICAgICAgICAgICAgICAgICAvLyBjb25zdCBpbnQgQU5EUk9JRF9DUFVfRkFNSUxZX0FSTTY0ID0gNDsKICAgICAgICAgICAgICAgICAgICByZXR2YWwucmVwbGFjZSg0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGNvbnNvbGUubG9nKCJbLV0gYW5kcm9pZF9nZXRDcHVGYW1pbHkgbmV2ZXIgY2FsbGVkIik7CiAgICAgICAgLy8gVE9ETzogdHJhY2UgUmVnaXN0ZXJOYXRpdmVzIGluIGNhc2UgdGhlIGxpYnJhcmllcyBhcmUgc3RyaXBwZWQuCiAgICB9Cn0pOwoKLyoqCiAqIEJ5cGFzcyBSb290IERldGVjdGlvbgogKiBAcGFyYW0ge2FueX0gZnVuY3Rpb24oCiAqIEByZXR1cm5zIHthbnl9CiAqLwpzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIHN0YWNrVHJhY2VIZXJlKGlzTG9nKSB7CiAgICAgICAgdmFyIEV4Y2VwdGlvbiA9IEphdmEudXNlKCJqYXZhLmxhbmcuRXhjZXB0aW9uIik7CiAgICAgICAgdmFyIExvZyA9IEphdmEudXNlKCJhbmRyb2lkLnV0aWwuTG9nIik7CiAgICAgICAgdmFyIHN0YWNraW5mbyA9IExvZy5nZXRTdGFja1RyYWNlU3RyaW5nKEV4Y2VwdGlvbi4kbmV3KCkpOwogICAgICAgIGlmIChpc0xvZykgewogICAgICAgICAgICBjb25zb2xlLmxvZygiWypdIFN0YWNrZWQgSW5mbyA6ICIgKyBzdGFja2luZm8pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBzdGFja2luZm87CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHN0YWNrVHJhY2VOYXRpdmVIZXJlKGlzTG9nKSB7CiAgICAgICAgdmFyIGJhY2t0cmFjZSA9IFRocmVhZC5iYWNrdHJhY2UodGhpcy5jb250ZXh0LCBCYWNrdHJhY2VyLkFDQ1VSQVRFKQogICAgICAgICAgICAubWFwKERlYnVnU3ltYm9sLmZyb21BZGRyZXNzKQogICAgICAgICAgICAuam9pbigiXG5cdCIpOwogICAgICAgIGNvbnNvbGUubG9nKCJbKl0gQmFja3RyYWNlIDogIiArIGJhY2t0cmFjZSk7CiAgICB9CgogICAgZnVuY3Rpb24gYnlwYXNzSmF2YUZpbGVDaGVjaygpIHsKICAgICAgICB2YXIgVW5peEZpbGVTeXN0ZW0gPSBKYXZhLnVzZSgiamF2YS5pby5Vbml4RmlsZVN5c3RlbSIpOwogICAgICAgIFVuaXhGaWxlU3lzdGVtLmNoZWNrQWNjZXNzLmltcGxlbWVudGF0aW9uID0gZnVuY3Rpb24gKGZpbGUsIGFjY2VzcykgewogICAgICAgICAgICB2YXIgc3RhY2sgPSBzdGFja1RyYWNlSGVyZShmYWxzZSk7CgogICAgICAgICAgICBjb25zdCBmaWxlbmFtZSA9IGZpbGUuZ2V0QWJzb2x1dGVQYXRoKCk7CgogICAgICAgICAgICBpZiAoZmlsZW5hbWUuaW5kZXhPZigibWFnaXNrIikgPj0gMCkgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIlsrXSBBbnRpIFJvb3QgRGV0ZWN0IC0gY2hlY2sgZmlsZTogIiArIGZpbGVuYW1lKTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNvbW1vblBhdGhzLmluZGV4T2YoZmlsZW5hbWUpID49IDApIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJbK10gQW50aSBSb290IERldGVjdCAtIGNoZWNrIGZpbGU6ICIgKyBmaWxlbmFtZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzLmNoZWNrQWNjZXNzKGZpbGUsIGFjY2Vzcyk7CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBieXBhc3NOYXRpdmVGaWxlQ2hlY2soKSB7CiAgICAgICAgdmFyIGZvcGVuID0gTW9kdWxlLmZpbmRFeHBvcnRCeU5hbWUoImxpYmMuc28iLCAiZm9wZW4iKTsKICAgICAgICBJbnRlcmNlcHRvci5hdHRhY2goZm9wZW4sIHsKICAgICAgICAgICAgb25FbnRlcjogZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5wdXRQYXRoID0gYXJnc1swXS5yZWFkVXRmOFN0cmluZygpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvbkxlYXZlOiBmdW5jdGlvbiAocmV0dmFsKSB7CiAgICAgICAgICAgICAgICBpZiAocmV0dmFsLnRvSW50MzIoKSAhPSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbW1vblBhdGhzLmluZGV4T2YodGhpcy5pbnB1dFBhdGgpID49IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIlsrXSBBbnRpIFJvb3QgRGV0ZWN0IC0gZm9wZW4gOiAiICsgdGhpcy5pbnB1dFBhdGgpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR2YWwucmVwbGFjZShwdHIoMHgwKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgIH0pOwoKICAgICAgICB2YXIgYWNjZXNzID0gTW9kdWxlLmZpbmRFeHBvcnRCeU5hbWUoImxpYmMuc28iLCAiYWNjZXNzIik7CiAgICAgICAgSW50ZXJjZXB0b3IuYXR0YWNoKGFjY2VzcywgewogICAgICAgICAgICBvbkVudGVyOiBmdW5jdGlvbiAoYXJncykgewogICAgICAgICAgICAgICAgdGhpcy5pbnB1dFBhdGggPSBhcmdzWzBdLnJlYWRVdGY4U3RyaW5nKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uTGVhdmU6IGZ1bmN0aW9uIChyZXR2YWwpIHsKICAgICAgICAgICAgICAgIGlmIChyZXR2YWwudG9JbnQzMigpID09IDApIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY29tbW9uUGF0aHMuaW5kZXhPZih0aGlzLmlucHV0UGF0aCkgPj0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiWytdIEFudGkgUm9vdCBEZXRlY3QgLSBhY2Nlc3MgOiAiICsgdGhpcy5pbnB1dFBhdGgpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR2YWwucmVwbGFjZShwdHIoLTEpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0UHJvcCgpIHsKICAgICAgICB2YXIgQnVpbGQgPSBKYXZhLnVzZSgiYW5kcm9pZC5vcy5CdWlsZCIpOwogICAgICAgIHZhciBUQUdTID0gQnVpbGQuY2xhc3MuZ2V0RGVjbGFyZWRGaWVsZCgiVEFHUyIpOwogICAgICAgIFRBR1Muc2V0QWNjZXNzaWJsZSh0cnVlKTsKICAgICAgICBUQUdTLnNldChudWxsLCAicmVsZWFzZS1rZXlzIik7CgogICAgICAgIHZhciBGSU5HRVJQUklOVCA9IEJ1aWxkLmNsYXNzLmdldERlY2xhcmVkRmllbGQoIkZJTkdFUlBSSU5UIik7CiAgICAgICAgRklOR0VSUFJJTlQuc2V0QWNjZXNzaWJsZSh0cnVlKTsKICAgICAgICBGSU5HRVJQUklOVC5zZXQoCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICJnb29nbGUvY3Jvc3NoYXRjaC9jcm9zc2hhdGNoOjEwL1FRM0EuMjAwODA1LjAwMS82NTc4MjEwOnVzZXIvcmVsZWFzZS1rZXlzIgogICAgICAgICk7CgogICAgICAgIC8vIEJ1aWxkLmRlcml2ZUZpbmdlcnByaW50LmlucGxlbWVudGF0aW9uID0gZnVuY3Rpb24oKXsKICAgICAgICAvLyAgICAgdmFyIHJldCA9IHRoaXMuZGVyaXZlRmluZ2VycHJpbnQoKSAvL+ivpeWHveaVsOaXoOazlemAmui/h+WPjeWwhOiwg+eUqAogICAgICAgIC8vICAgICBjb25zb2xlLmxvZyhyZXQpCiAgICAgICAgLy8gICAgIHJldHVybiByZXQKICAgICAgICAvLyB9CgogICAgICAgIHZhciBzeXN0ZW1fcHJvcGVydHlfZ2V0ID0gTW9kdWxlLmZpbmRFeHBvcnRCeU5hbWUoCiAgICAgICAgICAgICJsaWJjLnNvIiwKICAgICAgICAgICAgIl9fc3lzdGVtX3Byb3BlcnR5X2dldCIKICAgICAgICApOwogICAgICAgIEludGVyY2VwdG9yLmF0dGFjaChzeXN0ZW1fcHJvcGVydHlfZ2V0LCB7CiAgICAgICAgICAgIG9uRW50ZXIoYXJncykgewogICAgICAgICAgICAgICAgdGhpcy5rZXkgPSBhcmdzWzBdLnJlYWRDU3RyaW5nKCk7CiAgICAgICAgICAgICAgICB0aGlzLnJldCA9IGFyZ3NbMV07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uTGVhdmUocmV0KSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5rZXkgPT0gInJvLmJ1aWxkLmZpbmdlcnByaW50IikgewogICAgICAgICAgICAgICAgICAgIHZhciB0bXAgPQogICAgICAgICAgICAgICAgICAgICAgICAiZ29vZ2xlL2Nyb3NzaGF0Y2gvY3Jvc3NoYXRjaDoxMC9RUTNBLjIwMDgwNS4wMDEvNjU3ODIxMDp1c2VyL3JlbGVhc2Uta2V5cyI7CiAgICAgICAgICAgICAgICAgICAgdmFyIHAgPSBNZW1vcnkuYWxsb2NVdGY4U3RyaW5nKHRtcCk7CiAgICAgICAgICAgICAgICAgICAgTWVtb3J5LmNvcHkodGhpcy5yZXQsIHAsIHRtcC5sZW5ndGggKyAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICB9KTsKICAgIH0KCiAgICAvL2FuZHJvaWQuYXBwLlBhY2thZ2VNYW5hZ2VyCiAgICBmdW5jdGlvbiBieXBhc3NSb290QXBwQ2hlY2soKSB7CiAgICAgICAgdmFyIEFwcGxpY2F0aW9uUGFja2FnZU1hbmFnZXIgPSBKYXZhLnVzZSgKICAgICAgICAgICAgImFuZHJvaWQuYXBwLkFwcGxpY2F0aW9uUGFja2FnZU1hbmFnZXIiCiAgICAgICAgKTsKICAgICAgICBBcHBsaWNhdGlvblBhY2thZ2VNYW5hZ2VyLmdldFBhY2thZ2VJbmZvLm92ZXJsb2FkKAogICAgICAgICAgICAiamF2YS5sYW5nLlN0cmluZyIsCiAgICAgICAgICAgICJpbnQiCiAgICAgICAgKS5pbXBsZW1lbnRhdGlvbiA9IGZ1bmN0aW9uIChzdHIsIGkpIHsKICAgICAgICAgICAgLy8gY29uc29sZS5sb2coc3RyKQogICAgICAgICAgICBpZiAoUk9PVG1hbmFnZW1lbnRBcHAuaW5kZXhPZihzdHIpID49IDApIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJbK10gQW50aSBSb290IERldGVjdCAtIGNoZWNrIHBhY2thZ2UgOiAiICsgc3RyKTsKICAgICAgICAgICAgICAgIHN0ciA9ICJhc2hlbi5vbmUueWUubm90LmZvdW5kIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRQYWNrYWdlSW5mbyhzdHIsIGkpOwogICAgICAgIH07CgogICAgICAgIC8vc2hlbGwgcG0gY2hlY2sKICAgIH0KCiAgICBmdW5jdGlvbiBieXBhc3NTaGVsbENoZWNrKCkgewogICAgICAgIHZhciBTdHJpbmcgPSBKYXZhLnVzZSgiamF2YS5sYW5nLlN0cmluZyIpOwoKICAgICAgICB2YXIgUHJvY2Vzc0ltcGwgPSBKYXZhLnVzZSgiamF2YS5sYW5nLlByb2Nlc3NJbXBsIik7CiAgICAgICAgUHJvY2Vzc0ltcGwuc3RhcnQuaW1wbGVtZW50YXRpb24gPSBmdW5jdGlvbiAoCiAgICAgICAgICAgIGNtZGFycmF5LAogICAgICAgICAgICBlbnYsCiAgICAgICAgICAgIGRpciwKICAgICAgICAgICAgcmVkaXJlY3RzLAogICAgICAgICAgICByZWRpcmVjdEVycm9yU3RyZWFtCiAgICAgICAgKSB7CiAgICAgICAgICAgIGlmIChjbWRhcnJheVswXSA9PSAibW91bnQiKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiWytdIEFudGkgUm9vdCBEZXRlY3QgLSBTaGVsbCA6ICIgKyBjbWRhcnJheS50b1N0cmluZygpKTsKICAgICAgICAgICAgICAgIGFyZ3VtZW50c1swXSA9IEphdmEuYXJyYXkoImphdmEubGFuZy5TdHJpbmciLCBbU3RyaW5nLiRuZXcoIiIpXSk7CiAgICAgICAgICAgICAgICByZXR1cm4gUHJvY2Vzc0ltcGwuc3RhcnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNtZGFycmF5WzBdID09ICJnZXRwcm9wIikgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIlsrXSBBbnRpIFJvb3QgRGV0ZWN0IC0gU2hlbGwgOiAiICsgY21kYXJyYXkudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgICBjb25zdCBwcm9wID0gWyJyby5zZWN1cmUiLCAicm8uZGVidWdnYWJsZSJdOwogICAgICAgICAgICAgICAgaWYgKHByb3AuaW5kZXhPZihjbWRhcnJheVsxXSkgPj0gMCkgewogICAgICAgICAgICAgICAgICAgIGFyZ3VtZW50c1swXSA9IEphdmEuYXJyYXkoImphdmEubGFuZy5TdHJpbmciLCBbU3RyaW5nLiRuZXcoIiIpXSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFByb2Nlc3NJbXBsLnN0YXJ0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjbWRhcnJheVswXS5pbmRleE9mKCJ3aGljaCIpID49IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IHByb3AgPSBbInN1Il07CiAgICAgICAgICAgICAgICBpZiAocHJvcC5pbmRleE9mKGNtZGFycmF5WzFdKSA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIlsrXSBBbnRpIFJvb3QgRGV0ZWN0IC0gU2hlbGwgOiAiICsgY21kYXJyYXkudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgICAgICAgYXJndW1lbnRzWzBdID0gSmF2YS5hcnJheSgiamF2YS5sYW5nLlN0cmluZyIsIFtTdHJpbmcuJG5ldygiIildKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gUHJvY2Vzc0ltcGwuc3RhcnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIFByb2Nlc3NJbXBsLnN0YXJ0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfTsKICAgIH0KCiAgICBjb25zb2xlLmxvZygiQXR0YWNoIik7CiAgICBieXBhc3NOYXRpdmVGaWxlQ2hlY2soKTsKICAgIGJ5cGFzc0phdmFGaWxlQ2hlY2soKTsKICAgIHNldFByb3AoKTsKICAgIGJ5cGFzc1Jvb3RBcHBDaGVjaygpOwogICAgYnlwYXNzU2hlbGxDaGVjaygpOwoKfSwgMCk7Cg==").decode('utf-8'))
            print("✔ Bypass all")
            script_bypass.load()
            
            js_script = base64.b64decode("SW50ZXJjZXB0b3IuYXR0YWNoKE1vZHVsZS5maW5kRXhwb3J0QnlOYW1lKG51bGwsICJwdHJhY2UiKSwgewogICAgb25FbnRlcjogZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgICBjb25zb2xlLmxvZygicHRyYWNlIGNhbGxlZCEiKTsKICAgICAgICBzZW5kKCJwdHJhY2UiKTsKICAgICAgICAvL2NvbnNvbGUubG9nKGFyZ3MpOwogICAgfQp9KTsKCkludGVyY2VwdG9yLmF0dGFjaChNb2R1bGUuZmluZEV4cG9ydEJ5TmFtZShudWxsLCAiZXhpdCIpLCB7CiAgICBvbkVudGVyOiBmdW5jdGlvbiAoYXJncykgewogICAgICAgIGNvbnNvbGUubG9nKCJleGl0IGNhbGxlZCEiKTsKICAgICAgICBzZW5kKCJleGl0Iik7CiAgICAgICAgLy9jb25zb2xlLmxvZyhhcmdzKTsKICAgIH0KfSk7CgpJbnRlcmNlcHRvci5hdHRhY2goTW9kdWxlLmZpbmRFeHBvcnRCeU5hbWUobnVsbCwgImFib3J0IiksIHsKICAgIG9uRW50ZXI6IGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgICAgY29uc29sZS5sb2coImFib3J0IGNhbGxlZCEiKTsKICAgICAgICBzZW5kKCJhYm9ydCIpOwogICAgICAgIC8vY29uc29sZS5sb2coYXJncyk7CiAgICB9Cn0pOwoKSW50ZXJjZXB0b3IuYXR0YWNoKE1vZHVsZS5maW5kRXhwb3J0QnlOYW1lKG51bGwsICJmb3JrIiksIHsKICAgIG9uRW50ZXI6IGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgICAgY29uc29sZS5sb2coImZvcmsgY2FsbGVkISIpOwogICAgICAgIHNlbmQoImZvcmsiKTsKICAgICAgICAvL2NvbnNvbGUubG9nKGFyZ3MpOwogICAgfQp9KTsKCkludGVyY2VwdG9yLmF0dGFjaChNb2R1bGUuZmluZEV4cG9ydEJ5TmFtZShudWxsLCAidmZvcmsiKSwgewogICAgb25FbnRlcjogZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgICBjb25zb2xlLmxvZygidmZvcmsgY2FsbGVkISIpOwogICAgICAgIHNlbmQoInZmb3JrIik7CiAgICAgICAgLy9jb25zb2xlLmxvZyhhcmdzKTsKICAgIH0KfSk7CgpJbnRlcmNlcHRvci5hdHRhY2goTW9kdWxlLmZpbmRFeHBvcnRCeU5hbWUobnVsbCwgIl9lbmQiKSwgewogICAgb25FbnRlcjogZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgICBjb25zb2xlLmxvZygiZm9yayBjYWxsZWQhIik7CiAgICAgICAgc2VuZCgiZm9yayIpOwogICAgICAgIC8vY29uc29sZS5sb2coYXJncyk7CiAgICB9Cn0pOwoKSW50ZXJjZXB0b3IuYXR0YWNoKE1vZHVsZS5maW5kRXhwb3J0QnlOYW1lKG51bGwsICJfZXhpdCIpLCB7CiAgICBvbkVudGVyOiBmdW5jdGlvbiAoYXJncykgewogICAgICAgIGNvbnNvbGUubG9nKCJfZXhpdCBjYWxsZWQhIik7CiAgICAgICAgc2VuZCgiX2V4aXQiKTsKICAgICAgICAvL2NvbnNvbGUubG9nKGFyZ3MpOwogICAgfQp9KTsKCkludGVyY2VwdG9yLnJlcGxhY2UoTW9kdWxlLmZpbmRFeHBvcnRCeU5hbWUobnVsbCwgImtpbGwiKSwgbmV3IE5hdGl2ZUNhbGxiYWNrKGZ1bmN0aW9uKHBpZCwgc2lnKXsKICAgIGNvbnNvbGUubG9nKCJUcmllZCB0byBraWxsIHBpZDoiLHBpZCwic2lnOiIsc2lnKTsKICAgIHNlbmQoImtpbGwgc2VudCIpCiAgICByZXR1cm4gMDsKfSwnaW50JyxbJ2ludCcsJ2ludCddKSk7CgpzZW5kKCJTdGFydGVkIHNoaXQgaW4gdGhpcyBwaWQiKTsKCkphdmEucGVyZm9ybShmdW5jdGlvbigpIHsKICAgIGNvbnNvbGUubG9nKCIiKTsKICAgIGNvbnNvbGUubG9nKCJbLl0gRGVidWcgY2hlY2sgYnlwYXNzIik7CgogICAgdmFyIERlYnVnID0gSmF2YS51c2UoJ2FuZHJvaWQub3MuRGVidWcnKTsKICAgIERlYnVnLmlzRGVidWdnZXJDb25uZWN0ZWQuaW1wbGVtZW50YXRpb24gPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zb2xlLmxvZygnaXNEZWJ1Z2dlckNvbm5lY3RlZCBCeXBhc3NlZCAhJyk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHZhciBwcm9jZXNzID0gSmF2YS51c2UoJ2FuZHJvaWQub3MuUHJvY2VzcycpOwogICAgcHJvY2Vzcy5raWxsUHJvY2Vzcy5vdmVybG9hZCgnaW50JykuaW1wbGVtZW50YXRpb24gPSBmdW5jdGlvbihwaWQpIHsKICAgICAgICBjb25zb2xlLmxvZygnU2hpdCBoYXBwZW5zIGtpbGxwcm9jZXNzJyxwaWQpOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgc3lzdGVtID0gSmF2YS51c2UoJ2phdmEubGFuZy5TeXN0ZW0nKTsKICAgIHN5c3RlbS5leGl0Lm92ZXJsb2FkKCdpbnQnKS5pbXBsZW1lbnRhdGlvbiA9IGZ1bmN0aW9uIChwaWQpIHsKICAgICAgICBjb25zb2xlLmxvZygnRXhpdCBjYWxsZWQhJyk7CiAgICAgICAgc2VuZCgic3lzdGVtLmV4aXQiKQogICAgfQoKICAgIHZhciBydW50aW1lID0gSmF2YS51c2UoJ2phdmEubGFuZy5SdW50aW1lJyk7CiAgICBydW50aW1lLmhhbHQub3ZlcmxvYWQoJ2ludCcpLmltcGxlbWVudGF0aW9uID0gZnVuY3Rpb24odmFyXzApIHsKICAgICAgICBjb25zb2xlLmxvZygnaGFsdCBjYWxsZWQnKTsKICAgICAgICBzZW5kKCdoYWx0IGNhbGxlZCcpOwogICAgfQp9KTs=").decode('utf-8')
            script = session.create_script(js_script, runtime='v8')
            script.on("message", lambda message, data: self._reactor.schedule(lambda: self._on_message(pid, message)))
            print("✔ load()")
            script.load()

            js_script_open = base64.b64decode("SW50ZXJjZXB0b3IuYXR0YWNoKE1vZHVsZS5maW5kRXhwb3J0QnlOYW1lKG51bGwsICdvcGVuJyksIHsKICBvbkVudGVyOiBmdW5jdGlvbiAoYXJncykgewogICAgc2VuZCh7CiAgICAgIHR5cGU6ICdvcGVuJywKICAgICAgcGF0aDogTWVtb3J5LnJlYWRVdGY4U3RyaW5nKGFyZ3NbMF0pCiAgICB9KTsKICB9Cn0pOw==").decode("utf-8")
            script_spawn = session.create_script(js_script_open)
            script_spawn.on("message", lambda message, data:
                self._reactor.schedule(
                    lambda: self._on_message(pid, message)))
            print("✔ load()")
            script_spawn.load()

            print("✔ resume(pid={})".format(pid))
            self._device.resume(pid)
            self._sessions.add(session)
            
        except Exception as e:
            
            print(e)
            print("Something's wrong! resuming...")
            self._device.resume(pid)
            

    def _on_child_added(self, child):
        
        print("⚡ child_added: {}".format(child))
        
        if child.origin == 'exec':
            
            print('not instrumenting exec shit')
            self._device.resume(child.pid)
            return
        
        #if child.path != self.target and child.origin != 'fork':
            #print("Not instrumenting cause name is not expected.")
            #return
            
        self._instrument(child.pid)

    def _on_child_removed(self, child):
        
        print("⚡ child_removed: {}".format(child))

    def _on_output(self, pid, fd, data):
        
        print("⚡ output: pid={}, fd={}, data={}".format(pid, fd, repr(data)))

    def _on_detached(self, pid, session, reason):
        
        print("⚡ detached: pid={}, reason='{}'".format(pid, reason))
        self._sessions.remove(session)
        self._reactor.schedule(self._stop_if_idle, delay=0.5)

    def _on_message(self, pid, message):
        
        try:
            
            print("⚡ message: pid={}, payload={}".format(pid, message["payload"]))
            
        except:
            
            print(message)

if __name__ == "__main__":
    
    # Change Package Name
    target = "com.package"
    app = Application(target)
    app.run()
